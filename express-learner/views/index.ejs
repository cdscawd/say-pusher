<!DOCTYPE html>
<html>
  <head>
    <title><%= main %></title>
    <link rel="stylesheet" type="text/css" href="static/stylesheets/reset.css">
    <link rel="stylesheet" type="text/css" href="static/stylesheets/index.css">
  </head>
<body>
<div id="container">
  <iframe id="frame" src="static/curriculum/presentation"></iframe>
  <img class="praise " src="static/images/praise.gif" alt="">
  <div class="control">
    <div class="buttons">
      <button id="gotoFirstSlide">First Slide</button>
      <button id="prev_slide">Prev Slide</button>
      <button id="next_slide">Next Slide</button>		
      <button id="prev_step">Prev Step</button>
      <button id="next_step">Next Step</button>
      <button id="praise">praise</button>
      <button id="like">like</button>
    </div>
    <div id="end_time">课程结束倒计时 20' 00''</div>
    <div class="log">
      <p id="time"></p>
      <p id="slideIndex"></p>
    </div>	
  </div>
  <div id="logger"></div>
</div>
<script src="http://zeptojs.com/zepto.min.js"></script>
<script src="https://js.pusher.com/4.1/pusher.min.js"></script>
<!-- Ispring js -->
<script>
	/**
	* 	sessionRequestId=58d1b23d602a4a0001e66f33
	* 	sessionStartAt=1507073590164
	* 	sessionEndAt=1507679587594
	* 	lessonSlug=1072_2932_34582
			// http://localhost:8000/learner?sessionRequestId=58d1b23d602a4a0001e66ac6&sessionStartAt=1507073590164&sessionEndAt=1507679587594&lessonSlug=1072_2932_34572
	*/
	//Learner: http://localhost:3000/v1/qoocoSessions/learner?sessionRequestId=58d1b23d602a4a0001e66f33&sessionStartAt=1507073590164&sessionEndAt=1507679587594&lessonSlug=1072_2932_34582&locale=zh_CN
	//Teacher: http://localhost:3002/teacher/session?sessionRequestId=58d1b23d602a4a0001e66f33&sessionStartAt=1507073590164&sessionEndAt=1507679587594&lessonSlug=1072_2932_34582&locale=en
	// DEV Working Space

	var pusher = {}
	var channel;
	var sessionStartAt = window.location.search.match(/sessionStartAt=(\S*)&sessionEndAt/)[1];
	var sessionEndAt = window.location.search.match(/sessionEndAt=(\S*)&lessonSlug/)[1];
	var sessionRequestId = window.location.search.match(/sessionRequestId=(\S*)&sessionStartAt/)[1];
	var lessonSlug = window.location.search.match(/lessonSlug=(\S*)/)[1];
	
	$.get('http://192.168.0.103:8769/voip-web-api/pusher/key?lessonSlug='+lessonSlug+'&sessionRequestId='+sessionRequestId, function(res){
		pusher = res.data
		var pusherKey = res.data.pusherKey
		var cluster = res.data.cluster
		var channelName = res.data.channelName

		Pusher.logToConsole = true;
		var pusher = new Pusher(pusherKey, {
			cluster: cluster,
			encrypted: true,
			authTransport: 'jsonp',
			authEndpoint: 'http://192.168.0.103:8769/voip-web-api/pusher/auth'
		});
		channel = pusher.subscribe(channelName);
		channel.bind('client-teacher-click', function (data) {
			var EVENT_TYPE = data
			switch (EVENT_TYPE) {
				case 'NEXT_STEP':
					$('#next_step').trigger("click"); 
					break;
				case 'PREV_STEP':
					$('#prev_step').trigger("click"); 
					break;
				case 'NEXT_SLIDE':
					$('#next_slide').trigger("click"); 
					break;
				case 'PREV_SLIDE':
					$('#prev_slide').trigger("click"); 
					break;
				case 'FIRST_SLIDE':
					$('#gotoFirstSlide').trigger("click"); 
					break;
				default: break;
			}
		});
	})

	var PLAY = "播放动画"
	var PAUSE = "暂停动画"
	var COUNT_DOWN = 1200000
	var playbackController
	var prevSlideBtn = document.getElementById("prev_slide")
	var nextSlideBtn = document.getElementById("next_slide")
	var playPrevStepBtn = document.getElementById("prev_step")
	var playNextStepBtn = document.getElementById("next_step")
	var gotoFirstSlide = document.getElementById("gotoFirstSlide")
	var timeLabel = document.getElementById("time")
	var slideIndexLabel = document.getElementById("slideIndex")
	var slidesCount
	var isPlayedPresentation

	$('#praise').on('click', function() {
		$('.praise').addClass('animated fadeInUp')
		setTimeout(function() {
			$('.praise').removeClass('fadeInUp').addClass('fadeOutDown')
		},1000)
		setTimeout(function() {
			$('.praise').removeClass('animated fadeOutDown')
		},1500)
	})

	// player init
	var ispringPresentationConnector = {}
	ispringPresentationConnector.register = function(player) {
		logger("Teacher Player Running...")
		var presentation = player.presentation()
		slidesCount = presentation.slides().count()
		playbackController = player.view().playbackController()
		initPlaybackControllerEventsHandlers()
		initButtonsEventsHandlers()
		sessionCountDown()
		player.view().playbackController().slideChangeEvent().addHandler(function(slideIndex) {
			logger("Page : " + slideIndex)
		})
	}
	
	// player event
	// Player-SDK/documentation/js-api/ispring.presenter.player.IPresentationPlaybackController.html#playbackState
	function initPlaybackControllerEventsHandlers() {
		playbackController.slideChangeEvent().addHandler(function(slideIndex) {
			slideIndexLabel.innerHTML = "Slide: " + (slideIndex + 1) + " / " + slidesCount
		})
	
		playbackController.clock().tickEvent().addHandler(function(clock) {
			var timeOffset = clock.timestamp().timeOffset()
			var minutes = Math.floor(timeOffset / 60)
			var seconds = Math.round(timeOffset % 60)
			timeLabel.innerHTML = (minutes < 10) ? "0" + minutes: minutes
			timeLabel.innerHTML += ":"
			timeLabel.innerHTML += (seconds < 10) ? "0" + seconds: seconds
		})
	}
	// control button
	function initButtonsEventsHandlers() {
		prevSlideBtn.onclick = function() {
			playbackController.gotoPreviousSlide()
		}
		nextSlideBtn.onclick = function() {
			playbackController.gotoNextSlide()
		}
		playPrevStepBtn.onclick = function() {
			playbackController.gotoPreviousStep()
		}
		playNextStepBtn.onclick = function() {
			playbackController.gotoNextStep()
		}
		gotoFirstSlide.onclick = function() {
			playbackController.gotoFirstSlide(false)
		}
	}

	// debug logger 
	function logger(text) {
		var logger = document.getElementById("logger")
		logger.innerHTML = logger.innerHTML + text + '<br>'
	}

	// 倒计时 1200000
	function sessionCountDown() {
		var min, sec, LOCAL_COUNT_DOWN
		var timer = setInterval(function() {
			var neadGet = (typeof localStorage.getItem('LOCAL_COUNT_DOWN')) == 'object' ? true : false
			if (neadGet) {
				COUNT_DOWN = COUNT_DOWN - 1000
			} else {
				COUNT_DOWN = parseInt(localStorage.getItem('LOCAL_COUNT_DOWN'), 10)
				COUNT_DOWN = COUNT_DOWN - 1000
			}
			min = parseInt((COUNT_DOWN / 1000 / 60), 10)
			sec = parseInt((COUNT_DOWN - (min * 60 * 1000)) / 1000, 10)
			document.getElementById("end_time").innerHTML = "课程结束倒计时 " + min + "' " + sec + "''"
			LOCAL_COUNT_DOWN = (min * 60 * 1000) + (sec * 1000)
			window.localStorage.setItem('LOCAL_COUNT_DOWN', LOCAL_COUNT_DOWN)
			if (sec < 0) {
				document.getElementById("end_time").innerHTML = "你的课程已经结束"
				clearInterval(timer)
			}
		}, 1000)
	}
</script>
</body>
</html>
